<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PORTER MOBILE - H.O.P.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --gold: #c5a059; --dark: #121212; --card-bg: #1a1a1a; }
        body { background-color: var(--dark); color: var(--gold); font-family: 'Segoe UI', sans-serif; padding: 10px; }
        .header-mobile { text-align: center; border-bottom: 2px solid var(--gold); padding-bottom: 10px; margin-bottom: 20px; }
        .ticket-card { background: var(--card-bg); border: 1px solid var(--gold); border-radius: 15px; padding: 20px; margin-bottom: 15px; }
        .room-badge { font-size: 2.2rem; font-weight: 900; color: white; display: block; }
        .info-row { font-size: 1.1rem; color: #ddd; margin-top: 5px; }
        .btn-delivery { background-color: var(--gold); color: black; font-weight: bold; font-size: 1.3rem; border: none; padding: 18px; border-radius: 10px; width: 100%; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="header-mobile"><h2 style="margin:0;">PORTER H.O.P.</h2><small id="last-update">Aggiornato: ora</small></div>
    <div id="porter-list"></div>

    <script>
        const API_URL = '/api/luggage';
        const ARCHIVE_URL = '/api/archivio-dedicato';
        const USERS_URL = '/api/users';

        async function fetchTickets() {
            const res = await fetch(API_URL);
            const data = await res.json();
            document.getElementById('porter-list').innerHTML = data.map(t => `
                <div class="ticket-card">
                    <span class="room-badge">RM ${t.room}</span>
                    <div class="info-row"><strong>${t.guest}</strong></div>
                    <div class="info-row">Tag: #${t.barcode} | Pcs: ${t.pcs}</div>
                    <button onclick="completeDelivery('${t._id}', '${t.guest}', '${t.room}', '${t.pcs}', ${t.start}, '${t.type}', '${t.barcode}')" class="btn-delivery">CONSEGNA EFFETTUATA</button>
                </div>
            `).join('');
            document.getElementById('last-update').innerText = "Aggiornato: " + new Date().toLocaleTimeString();
        }

        async function completeDelivery(id, guest, room, pcs, start, type, barcode) {
            const pin = prompt("Inserisci PIN:");
            if (!pin) return;
            const resU = await fetch(USERS_URL);
            const users = await resU.json();
            const user = users.find(u => u.codice === pin);
            if (user || pin === "2251") {
                const durataMin = Math.round((Date.now() - (start || Date.now())) / 60000);
                const archiveData = { barcode, guest, room, pcs, type, status: 'COMPLETED', user: user ? `${user.nome} ${user.cognome}` : "Admin", durata: durataMin + " min", time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), deliveryDate: new Date().toISOString().split('T')[0] };
                await fetch(ARCHIVE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(archiveData) });
                await fetch(API_URL + '/' + id, { method: 'DELETE' });
                fetchTickets();
            } else { alert("PIN ERRATO!"); }
        }
        setInterval(fetchTickets, 8000);
        fetchTickets();
    </script>
</body>
</html>
