<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Gestione Utenti - HOP System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --gold: #c5a059; }
        body { background: #000; color: white; font-family: 'Times New Roman', serif; padding: 40px; }
        .container-box { max-width: 1000px; margin: auto; border: 1px solid var(--gold); padding: 30px; background: #111; }
        .table { color: white; border-color: #333; }
        .form-control, .form-select { background: #1a1a1a; border: 1px solid #444; color: white; border-radius: 0; }
        .form-control:focus { background: #222; color: white; border-color: var(--gold); box-shadow: none; }
        .btn-gold { background: var(--gold); color: black; border: none; font-weight: bold; border-radius: 0; }
        .gold-text { color: var(--gold); }
        .action-icon { cursor: pointer; color: var(--gold); }
        .badge-role { font-size: 0.75rem; padding: 5px 10px; border: 1px solid var(--gold); color: var(--gold); }
    </style>
</head>
<body>

<div class="container-box">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="gold-text mb-0">USER MANAGEMENT</h2>
        <a href="index.html" class="btn btn-outline-light btn-sm">EXIT</a>
    </div>

    <div class="row g-2 mb-4 p-3" style="background: rgba(197, 160, 89, 0.05); border: 1px dashed var(--gold);">
        <div class="col-md-3"><label class="small gold-text">NOME</label><input type="text" id="userNome" class="form-control"></div>
        <div class="col-md-3"><label class="small gold-text">COGNOME</label><input type="text" id="userCognome" class="form-control"></div>
        <div class="col-md-2">
            <label class="small gold-text">ROLE</label>
            <select id="userRole" class="form-select">
                <option value="BellMan">BellMan</option>
                <option value="Concierge">Concierge</option>
            </select>
        </div>
        <div class="col-md-2"><label class="small gold-text">PIN</label><input type="text" id="userPin" class="form-control" maxlength="4"></div>
        <div class="col-md-2 d-flex align-items-end"><button class="btn btn-gold w-100" onclick="addUser()">AGGIUNGI</button></div>
    </div>

    <table class="table">
        <thead><tr class="gold-text"><th>NOME</th><th>COGNOME</th><th>RUOLO</th><th>PIN</th><th class="text-end">AZIONI</th></tr></thead>
        <tbody id="userTableBody"></tbody>
    </table>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-gold text-white" style="border: 1px solid var(--gold);">
            <div class="modal-header border-secondary"><h5 class="modal-title gold-text">MODIFICA UTENTE</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="editUserId">
                <div class="mb-3"><label class="small gold-text">NOME</label><input type="text" id="editNome" class="form-control"></div>
                <div class="mb-3"><label class="small gold-text">COGNOME</label><input type="text" id="editCognome" class="form-control"></div>
                <div class="mb-3">
                    <label class="small gold-text">RUOLO</label>
                    <select id="editRole" class="form-select"><option value="BellMan">BellMan</option><option value="Concierge">Concierge</option></select>
                </div>
                <div class="mb-3"><label class="small gold-text">PIN</label><input type="text" id="editPin" class="form-control" maxlength="4"></div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteUser()">ELIMINA</button>
                <button type="button" class="btn btn-gold btn-sm" onclick="saveEdit()">SALVA MODIFICHE</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const USERS_API = '/api/users';
    let allUsers = [];
    const modal = new bootstrap.Modal(document.getElementById('editModal'));

    async function loadUsers() {
        try {
            const res = await fetch(USERS_API);
            allUsers = await res.json();
            document.getElementById('userTableBody').innerHTML = allUsers.map((u, i) => `
                <tr>
                    <td>${u.nome}</td><td>${u.cognome}</td><td><span class="badge-role">${u.role}</span></td>
                    <td class="gold-text fw-bold">${u.codice}</td>
                    <td class="text-end"><span class="action-icon" onclick="openEdit(${i})">⚙️</span></td>
                </tr>`).join('');
            // Genera un PIN casuale solo se il campo è vuoto
            if (!document.getElementById('userPin').value) {
                document.getElementById('userPin').value = Math.floor(1000 + Math.random() * 9000);
            }
        } catch (err) {
            console.error("Errore caricamento utenti:", err);
        }
    }

   async function addUser() {
    const nomeInput = document.getElementById('userNome').value.trim();
    const cognomeInput = document.getElementById('userCognome').value.trim();
    const pinInput = document.getElementById('userPin').value.trim();

    if (!nomeInput || !cognomeInput || !pinInput) {
        alert("Compila tutti i campi prima di aggiungere.");
        return;
    }

    // Creiamo l'oggetto inviando il PIN in tutti i formati comuni
    const data = {
        nome: nomeInput,
        cognome: cognomeInput,
        role: document.getElementById('userRole').value,
        codice: pinInput, // Quello che usi attualmente
        pin: pinInput     // Alternativa comune nei database
    };

    console.log("Invio dati al server:", data);

    try {
        const res = await fetch(USERS_API, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(data) 
        });

        if (res.ok) {
            alert("Utente aggiunto con successo!");
            document.getElementById('userNome').value = "";
            document.getElementById('userCognome').value = "";
            document.getElementById('userPin').value = Math.floor(1000 + Math.random() * 9000);
            loadUsers();
        } else {
            // Proviamo a leggere il motivo esatto dell'errore dal server
            const errorDetail = await res.text();
            console.error("Dettaglio errore server:", errorDetail);
            alert("Il server ha rifiutato il salvataggio. Controlla la console (F12) per i dettagli.");
        }
    } catch (err) {
        alert("Errore di connessione: il server è raggiungibile?");
    }
}
    function openEdit(i) {
        const u = allUsers[i];
        document.getElementById('editUserId').value = u._id;
        document.getElementById('editNome').value = u.nome;
        document.getElementById('editCognome').value = u.cognome;
        document.getElementById('editRole').value = u.role;
        document.getElementById('editPin').value = u.codice;
        modal.show();
    }

    async function saveEdit() {
    const id = document.getElementById('editUserId').value;
    const data = {
        nome: document.getElementById('editNome').value.trim(),
        cognome: document.getElementById('editCognome').value.trim(),
        role: document.getElementById('editRole').value,
        codice: document.getElementById('editPin').value.trim()
    };

    if (!data.nome || !data.cognome || !data.codice) {
        alert("Tutti i campi sono obbligatori.");
        return;
    }

    // 1. Eliminiamo prima il vecchio record per liberare il PIN
    const delRes = await fetch(`${USERS_API}/${id}`, { method: 'DELETE' });

    if (delRes.ok) {
        // 2. Ora creiamo il nuovo record
        const postRes = await fetch(USERS_API, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(data) 
        });

        if (postRes.ok) {
            modal.hide();
            loadUsers();
        } else {
            alert("Il vecchio utente è stato rimosso, ma non è stato possibile creare il nuovo. Verifica i dati.");
        }
    } else {
        alert("Errore durante la rimozione del vecchio profilo.");
    }
}
    async function deleteUser() {
        if(!confirm("Eliminare definitivamente l'utente?")) return;
        const id = document.getElementById('editUserId').value;
        const res = await fetch(`${USERS_API}/${id}`, { method: 'DELETE' });
        if (res.ok) {
            modal.hide();
            loadUsers();
        } else {
            alert("Errore durante l'eliminazione.");
        }
    }

    loadUsers();
</script>
</body>
</html>


